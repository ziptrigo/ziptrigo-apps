{% extends "base.html" %}
{% load static %}

{% block title %}Reset password{% endblock %}

{% block content %}
<div class="flex-grow flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-white/70 dark:bg-gray-800/60 backdrop-blur rounded-lg shadow p-6">
    <div class="flex items-center gap-3 mb-6">
      <img src="{% static 'images/logo_128x128.png' %}" alt="Logo" class="h-8 w-8">
      <h1 class="text-xl font-semibold">Set a new password</h1>
    </div>

    <div id="reset-msg" class="mb-4 text-sm"></div>

    <form id="reset-form"
          hx-post="/api/reset-password"
          hx-trigger="submit"
          hx-swap="none"
          x-data>
      {% csrf_token %}
      <input type="hidden" name="token" value="{{ token }}">

      <label class="block mb-3">
        <span class="block mb-1">New password</span>
        <input type="password" name="password" required
               minlength="6"
               class="w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-primary">
      </label>

      <label class="block mb-3">
        <span class="block mb-1">Confirm password</span>
        <input type="password" name="password_confirm" required
               minlength="6"
               class="w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-primary">
      </label>

      <button type="submit"
              class="w-full inline-flex justify-center items-center rounded bg-brand-primary text-gray-900 font-medium py-2 hover:opacity-90">
        Save new password
      </button>
    </form>
  </div>
</div>

<script>
  (function(){
    const form = document.getElementById('reset-form');
    const msg = document.getElementById('reset-msg');

    form.addEventListener('submit', function(ev){
      if (!form.checkValidity()) {
        msg.textContent = 'Please fill in both password fields.';
        msg.className = 'mb-4 text-sm text-red-600';
        return;
      }
      const pwd = form.querySelector('input[name="password"]').value;
      const pwd2 = form.querySelector('input[name="password_confirm"]').value;
      if (pwd !== pwd2) {
        msg.textContent = 'Passwords do not match.';
        msg.className = 'mb-4 text-sm text-red-600';
        ev.preventDefault();
        return;
      }
      msg.textContent = '';
      msg.className = 'mb-4 text-sm';
    });

    document.body.addEventListener('htmx:afterRequest', function(e){
      if (e.target !== form) return;
      const status = e.detail.xhr.status;
      try {
        const data = JSON.parse(e.detail.xhr.responseText || '{}');
        if (status >= 200 && status < 300) {
          msg.textContent = 'Your password has been reset. You can now log in.';
          msg.className = 'mb-4 text-sm text-green-700';
          setTimeout(function(){ window.location = '/login/'; }, 1500);
        } else {
          const userMsg = data.detail || data.message || 'Could not reset password.';
          msg.textContent = userMsg;
          msg.className = 'mb-4 text-sm text-red-600';
        }
      } catch (err) {
        if (status >= 200 && status < 300) {
          msg.textContent = 'Your password has been reset. You can now log in.';
          msg.className = 'mb-4 text-sm text-green-700';
          setTimeout(function(){ window.location = '/login/'; }, 1500);
        } else {
          msg.textContent = 'An unexpected error occurred.';
          msg.className = 'mb-4 text-sm text-red-600';
        }
      }
    });
  })();
</script>
{% endblock %}